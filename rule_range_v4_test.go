package ipacl

import (
	"testing"
)

func TestRuleRangeV4ListAddRange(t *testing.T) {
	type testCase struct {
		list, r, want string
	}
	runTestCases := func(t *testing.T, testCases []testCase) {
		for _, tc := range testCases {
			list := mustParseRuleRangeV4List(tc.list)
			r := mustParseRuleRangeV4(tc.r)
			added := ruleRangeV4ListAddRange(list, r)
			got := formatRuleRangeV4List(added)
			if got != tc.want {
				t.Errorf("result mismatch, list=%s, r=%s,\n got=%s,\nwant=%s", tc.list, tc.r, got, tc.want)
			}
		}
	}

	t.Run("sameAction", func(t *testing.T) {
		runTestCases(t, []testCase{
			{list: "", r: "192.0.2.4-192.0.2.7", want: "192.0.2.4-192.0.2.7"},
			{list: "192.0.2.4-192.0.2.7", r: "192.0.2.8-192.0.2.9", want: "192.0.2.4-192.0.2.9"},
			{list: "192.0.2.4-192.0.2.7", r: "192.0.2.9-192.0.2.10", want: "192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10"},
			{list: "192.0.2.4-192.0.2.7", r: "192.0.2.9-255.255.255.255", want: "192.0.2.4-192.0.2.7, 192.0.2.9-255.255.255.255"},
			{list: "192.0.2.4-192.0.2.7", r: "0.0.0.0-192.0.2.2", want: "0.0.0.0-192.0.2.2, 192.0.2.4-192.0.2.7"},
			{list: "192.0.2.4-192.0.2.7", r: "0.0.0.0-192.0.2.3", want: "0.0.0.0-192.0.2.7"},
			{list: "192.0.2.4-192.0.2.7", r: "0.0.0.0-192.0.2.5", want: "0.0.0.0-192.0.2.7"},
			{list: "192.0.2.4-192.0.2.7", r: "0.0.0.0-192.0.2.7", want: "0.0.0.0-192.0.2.7"},
			{list: "192.0.2.4-192.0.2.7", r: "0.0.0.0-255.255.255.255", want: "0.0.0.0-255.255.255.255"},
			{list: "192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.8-192.0.2.8", want: "192.0.2.4-192.0.2.10"},
			{list: "192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.3-192.0.2.11", want: "192.0.2.3-192.0.2.11"},
			{list: "192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.0-192.0.2.2", want: "192.0.2.0-192.0.2.2, 192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10"},
			{list: "192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.0-192.0.2.3", want: "192.0.2.0-192.0.2.7, 192.0.2.9-192.0.2.10"},
			{list: "192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.11-192.0.2.12", want: "192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.12"},
			{list: "192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "0.0.0.0-255.255.255.255", want: "0.0.0.0-255.255.255.255"},
			{list: "192.0.2.0-192.0.2.2, 192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.2-192.0.2.3", want: "192.0.2.0-192.0.2.7, 192.0.2.9-192.0.2.10"},
			{list: "192.0.2.1-192.0.2.2, 192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.0-192.0.2.3", want: "192.0.2.0-192.0.2.7, 192.0.2.9-192.0.2.10"},
		})
	})
	t.Run("differentAction", func(t *testing.T) {
		runTestCases(t, []testCase{
			{list: "", r: "!192.0.2.4-192.0.2.7", want: "!192.0.2.4-192.0.2.7"},
			{list: "!192.0.2.4-192.0.2.7", r: "192.0.2.8-192.0.2.9", want: "!192.0.2.4-192.0.2.7, 192.0.2.8-192.0.2.9"},
			{list: "!192.0.2.4-192.0.2.7", r: "192.0.2.9-192.0.2.10", want: "!192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10"},
			{list: "!192.0.2.4-192.0.2.7", r: "192.0.2.9-255.255.255.255", want: "!192.0.2.4-192.0.2.7, 192.0.2.9-255.255.255.255"},
			{list: "!192.0.2.4-192.0.2.7", r: "0.0.0.0-192.0.2.2", want: "0.0.0.0-192.0.2.2, !192.0.2.4-192.0.2.7"},
			{list: "!192.0.2.4-192.0.2.7", r: "0.0.0.0-192.0.2.3", want: "0.0.0.0-192.0.2.3, !192.0.2.4-192.0.2.7"},
			{list: "!192.0.2.4-192.0.2.7", r: "0.0.0.0-192.0.2.5", want: "0.0.0.0-192.0.2.3, !192.0.2.4-192.0.2.7"},
			{list: "!192.0.2.4-192.0.2.7", r: "0.0.0.0-192.0.2.7", want: "0.0.0.0-192.0.2.3, !192.0.2.4-192.0.2.7"},
			{list: "!192.0.2.4-192.0.2.7", r: "0.0.0.0-255.255.255.255", want: "0.0.0.0-192.0.2.3, !192.0.2.4-192.0.2.7, 192.0.2.8-255.255.255.255"},
			{list: "!192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.0-192.0.2.7", want: "192.0.2.0-192.0.2.3, !192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10"},
			{list: "!192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.0-192.0.2.8", want: "192.0.2.0-192.0.2.3, !192.0.2.4-192.0.2.7, 192.0.2.8-192.0.2.10"},
			{list: "!192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.0-192.0.2.11", want: "192.0.2.0-192.0.2.3, !192.0.2.4-192.0.2.7, 192.0.2.8-192.0.2.11"},
			{list: "!192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.3-192.0.2.11", want: "192.0.2.3, !192.0.2.4-192.0.2.7, 192.0.2.8-192.0.2.11"},
			{list: "!192.0.2.4-192.0.2.7, 192.0.2.9-192.0.2.10", r: "192.0.2.4-192.0.2.11", want: "!192.0.2.4-192.0.2.7, 192.0.2.8-192.0.2.11"},
			{list: "!192.0.2.4-192.0.2.7, !192.0.2.9-192.0.2.10, 192.0.2.14-192.0.2.16", r: "192.0.2.3-192.0.2.13",
				want: "192.0.2.3, !192.0.2.4-192.0.2.7, 192.0.2.8, !192.0.2.9-192.0.2.10, 192.0.2.11-192.0.2.16"},
			{list: "!192.0.2.4-192.0.2.7, !192.0.2.9-192.0.2.10, 192.0.2.14-192.0.2.16", r: "!192.0.2.3-192.0.2.13",
				want: "!192.0.2.3-192.0.2.13, 192.0.2.14-192.0.2.16"},
			{list: "!192.0.2.4-192.0.2.7, !192.0.2.9-192.0.2.10, 192.0.2.14-192.0.2.16", r: "!192.0.2.3-192.0.2.17",
				want: "!192.0.2.3-192.0.2.13, 192.0.2.14-192.0.2.16, !192.0.2.17"},
			{list: "0.0.0.0-192.0.2.3, !192.0.2.4-192.0.2.7, 192.0.2.8-255.255.255.255", r: "!0.0.0.0-255.255.255.255",
				want: "0.0.0.0-192.0.2.3, !192.0.2.4-192.0.2.7, 192.0.2.8-255.255.255.255"},
		})
	})
}
